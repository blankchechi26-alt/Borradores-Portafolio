# -*- coding: utf-8 -*-
"""Borrador 7.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1cn1ZFTxXnVTVFMPaEH7ao5FuZEvTmRpH
"""

import streamlit as st
import pandas as pd
import yfinance as yf
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime, timedelta
import numpy as np

# Configuraci√≥n de la p√°gina
st.set_page_config(
    page_title="An√°lisis de Acciones",
    page_icon="üìà",
    layout="wide"
)

# T√≠tulo de la aplicaci√≥n
st.title("üìà Demo: An√°lisis de Acciones")
st.markdown("---")

# Sidebar para controles
st.sidebar.header("Configuraci√≥n")

# Selecci√≥n de tickers por defecto
default_tickers = ['AAPL', 'GOOGL', 'MSFT', 'TSLA', 'AMZN']

tickers_input = st.sidebar.text_input(
    "S√≠mbolos de acciones (separados por coma):",
    value=", ".join(default_tickers)
)

# Procesar los tickers
tickers = [ticker.strip().upper() for ticker in tickers_input.split(',') if ticker.strip()]

# Selector de fecha
col1, col2 = st.sidebar.columns(2)
with col1:
    start_date = st.date_input(
        "Fecha de inicio:",
        value=datetime.now() - timedelta(days=365)
    )
with col2:
    end_date = st.date_input(
        "Fecha de fin:",
        value=datetime.now()
    )

# Selector de intervalo
interval = st.sidebar.selectbox(
    "Intervalo:",
    options=["1d", "1wk", "1mo"],
    index=0
)

# Funci√≥n segura para descargar datos
@st.cache_data(ttl=3600)  # Cache por 1 hora
def download_stock_data(tickers, start_date, end_date, interval):
    """
    Descarga datos de acciones de manera segura
    """
    try:
        data = yf.download(
            tickers=tickers,
            start=start_date,
            end=end_date,
            interval=interval,
            progress=False
        )

        # Verificar si se descargaron datos
        if data.empty:
            st.error("No se pudieron descargar datos. Verifica los s√≠mbolos y fechas.")
            return None

        return data

    except Exception as e:
        st.error(f"Error al descargar datos: {str(e)}")
        return None

# Bot√≥n para cargar datos
if st.sidebar.button("Cargar Datos", type="primary"):
    with st.spinner("Descargando datos..."):
        stock_data = download_stock_data(tickers, start_date, end_date, interval)
else:
    # Datos por defecto
    stock_data = download_stock_data(default_tickers, start_date, end_date, interval)

# Mostrar datos si est√°n disponibles
if stock_data is not None:

    # Pesta√±as para diferentes an√°lisis
    tab1, tab2, tab3, tab4 = st.tabs(["üìä Precios", "üìà Rendimientos", "üîç Correlaciones", "üìã Datos"])

    with tab1:
        st.subheader("Precios de Cierre Ajustados")

        # Obtener precios de cierre ajustados de manera segura
        if 'Adj Close' in stock_data.columns:
            prices = stock_data['Adj Close']
        else:
            # Si no hay columna multi-nivel, usar directamente
            prices = stock_data

        # Limpiar datos nulos
        prices = prices.dropna()

        if not prices.empty:
            # Normalizar precios para comparaci√≥n (base 100)
            normalized_prices = (prices / prices.iloc[0]) * 100

            # Gr√°fico de precios
            fig, ax = plt.subplots(figsize=(12, 6))
            for column in normalized_prices.columns:
                ax.plot(normalized_prices.index, normalized_prices[column], label=column, linewidth=2)

            ax.set_title('Evoluci√≥n de Precios (Normalizado)', fontsize=16, fontweight='bold')
            ax.set_xlabel('Fecha')
            ax.set_ylabel('Precio (Base 100)')
            ax.legend()
            ax.grid(True, alpha=0.3)
            plt.xticks(rotation=45)
            st.pyplot(fig)

            # Estad√≠sticas r√°pidas
            st.subheader("Estad√≠sticas de Precios")
            col1, col2, col3, col4 = st.columns(4)

            latest_prices = prices.iloc[-1]
            price_changes = ((prices.iloc[-1] - prices.iloc[0]) / prices.iloc[0]) * 100

            for i, ticker in enumerate(prices.columns):
                with [col1, col2, col3, col4][i % 4]:
                    st.metric(
                        label=ticker,
                        value=f"${latest_prices[ticker]:.2f}",
                        delta=f"{price_changes[ticker]:.2f}%"
                    )

    with tab2:
        st.subheader("Rendimientos Diarios")

        if 'Adj Close' in stock_data.columns:
            prices = stock_data['Adj Close'].dropna()
        else:
            prices = stock_data.dropna()

        if not prices.empty:
            # Calcular rendimientos
            returns = prices.pct_change().dropna()

            # Gr√°fico de rendimientos
            fig, ax = plt.subplots(figsize=(12, 6))
            returns.plot(ax=ax)
            ax.set_title('Rendimientos Diarios', fontsize=16, fontweight='bold')
            ax.set_xlabel('Fecha')
            ax.set_ylabel('Rendimiento')
            ax.legend()
            ax.grid(True, alpha=0.3)
            plt.xticks(rotation=45)
            st.pyplot(fig)

            # Distribuci√≥n de rendimientos
            st.subheader("Distribuci√≥n de Rendimientos")
            fig, axes = plt.subplots(2, 2, figsize=(12, 10))
            axes = axes.flatten()

            for i, ticker in enumerate(returns.columns[:4]):
                axes[i].hist(returns[ticker].dropna(), bins=50, alpha=0.7, edgecolor='black')
                axes[i].set_title(f'Distribuci√≥n - {ticker}')
                axes[i].set_xlabel('Rendimiento')
                axes[i].set_ylabel('Frecuencia')
                axes[i].grid(True, alpha=0.3)

            plt.tight_layout()
            st.pyplot(fig)

    with tab3:
        st.subheader("Matriz de Correlaci√≥n")

        if 'Adj Close' in stock_data.columns:
            prices = stock_data['Adj Close'].dropna()
        else:
            prices = stock_data.dropna()

        if not prices.empty:
            returns = prices.pct_change().dropna()
            correlation_matrix = returns.corr()

            # Heatmap de correlaciones
            fig, ax = plt.subplots(figsize=(10, 8))
            sns.heatmap(
                correlation_matrix,
                annot=True,
                cmap='coolwarm',
                center=0,
                square=True,
                ax=ax
            )
            ax.set_title('Matriz de Correlaci√≥n entre Acciones', fontsize=16, fontweight='bold')
            st.pyplot(fig)

    with tab4:
        st.subheader("Datos en Tiempo Real")

        if 'Adj Close' in stock_data.columns:
            display_data = stock_data['Adj Close']
        else:
            display_data = stock_data

        # Mostrar √∫ltimas 10 filas
        st.dataframe(display_data.tail(10), use_container_width=True)

        # Descargar datos
        csv = display_data.to_csv()
        st.download_button(
            label="Descargar CSV",
            data=csv,
            file_name=f"stock_data_{datetime.now().strftime('%Y%m%d')}.csv",
            mime="text/csv"
        )

else:
    st.warning("""
    ‚ö†Ô∏è No se pudieron cargar los datos. Algunas posibles soluciones:

    1. **Verifica los s√≠mbolos**: Aseg√∫rate de que los s√≠mbolos de acciones sean correctos
    2. **Revisa las fechas**: Las fechas deben ser v√°lidas y en orden cronol√≥gico
    3. **Problemas de conexi√≥n**: Verifica tu conexi√≥n a internet
    4. **S√≠mbolos populares**: Prueba con AAPL, GOOGL, MSFT, TSLA

    Ejemplo de formato correcto: `AAPL, GOOGL, MSFT`
    """)

# Informaci√≥n adicional en el sidebar
st.sidebar.markdown("---")
st.sidebar.info("""
**üí° Tips:**
- Usa s√≠mbolos v√°lidos de Yahoo Finance
- Intervalos disponibles: 1d, 1wk, 1mo
- Los datos se actualizan autom√°ticamente
""")

# Footer
st.markdown("---")
st.markdown(
    "üìä *Demo creado para an√°lisis de datos financieros* ‚Ä¢ "
    "Usa los controles laterales para personalizar tu an√°lisis"
)